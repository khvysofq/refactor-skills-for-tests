# Phase 02: 工程深度分析

> **前置条件**：Phase 01 完成（门禁基线已建立）  
> **目标**：形成完整的工程结构认知与模块依赖图

---

## 进入条件

- Phase 01 验收通过
- 或从 [README](../README.md) 决策树判断需要执行此阶段

---

## 执行指令

**加载 Skill**：阅读并执行 → [Skill 02: 工程深度分析](../skills/skill-02-analysis.md)

---

## 阶段验收标准

在 Skill 02 完成后，验证以下条件全部满足：

### 必须满足

- [ ] **模块地图文档存在**
  ```bash
  cat docs/architecture/module_map.md
  # 应包含模块列表和依赖关系
  ```

- [ ] **覆盖率检查**：至少 80% 主要模块有记录
  ```
  列出的模块数 / 实际模块总数 >= 80%
  ```

- [ ] **每个模块有完整描述**：
  - [ ] 职责说明
  - [ ] 边界定义（输入/输出）
  - [ ] 依赖类型标注（I/O/线程/硬件/全局状态）

- [ ] **编译体系文档化**
  ```bash
  cat docs/build/build_entrypoints.md
  # 应包含构建命令和 target 说明
  ```

### 质量检查

- [ ] 依赖方向是否正确（无循环依赖或已标注）
- [ ] 高风险模块是否已识别（并发/硬件/全局状态）
- [ ] 测试切入点建议是否合理

---

## 阶段产出物

| 产出 | 路径 | 说明 |
|------|------|------|
| 模块地图 | `docs/architecture/module_map.md` | 模块及依赖关系 |
| 构建入口 | `docs/build/build_entrypoints.md` | 编译体系说明 |
| 依赖图 | `docs/architecture/dependencies.md` | 可选，详细依赖 |

---

## 模块地图最小内容要求

```markdown
# 模块地图

## 模块列表

### 模块名称
- **职责**：一句话描述
- **边界**：
  - 输入：xxx
  - 输出：xxx
- **依赖**：
  - 内部：模块A, 模块B
  - 外部：filesystem, network, time
- **风险标注**：I/O | 线程 | 全局状态 | 硬件
- **测试建议**：L1/L2/L3

（重复以上结构）
```

---

## 完成后跳转

| 验收结果 | 下一步 |
|----------|--------|
| 通过 | 进入 [Phase 03: 优先级排序](03-prioritization.md) |
| 未通过 | 返回 Skill 02 补充分析 |

---

## 分析技巧

### 识别模块边界

1. 查看目录结构（通常目录=模块）
2. 查看构建文件（CMakeLists.txt / BUILD / Makefile）
3. 查看头文件暴露的接口
4. 查看 include 依赖关系

### 识别依赖类型

| 依赖特征 | 类型标注 |
|----------|----------|
| 文件读写 | I/O |
| 网络操作 | I/O |
| 创建线程/使用锁 | 线程 |
| 使用全局变量/单例 | 全局状态 |
| 调用硬件 SDK | 硬件 |
| 使用 time()/rand() | 非确定性 |

### 快速依赖分析

```bash
# 查看 include 依赖
grep -r "#include" src/ | sort | uniq -c | sort -rn

# 查看符号依赖（需要编译产物）
nm -C libxxx.a | grep " U " | sort | uniq
```

---

## 时间预估

| 工程规模 | 预估时间 |
|----------|----------|
| 小型（<10 模块） | 1-2 小时 |
| 中型（10-50 模块） | 2-4 小时 |
| 大型（>50 模块） | 4-8 小时 |

---

**执行**：立即加载 [Skill 02](../skills/skill-02-analysis.md) 开始执行
