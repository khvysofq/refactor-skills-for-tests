# 状态定义

> **阅读时机**：进行模块评估或处理门禁结果时。

---

## 模块评估状态（S1-S4）

由 [Skill 04: 可测试性评估](../skills/skill-04-assessment.md) 输出。

### S1: 可直接单测

**特征**：
- 模块边界清晰
- 依赖可替换（接口/注入点存在）
- 无强副作用，或副作用可注入控制

**后续路径**：Skill 06（直接单测覆盖）

**判定依据**：
- [ ] 核心逻辑为纯函数或可测方法
- [ ] 外部依赖已有抽象层
- [ ] 无全局状态直接访问
- [ ] 无硬编码 I/O/网络/时间调用

### S2: 可表征

**特征**：
- 难做纯单测（依赖复杂/副作用多）
- 但能在模块边界做 Golden Master
- 行为稳定可复现

**后续路径**：Skill 05（表征测试） → Skill 07（解耦）

**判定依据**：
- [ ] 有明确的输入输出边界
- [ ] 行为确定性（无随机/时间/并发依赖，或可控制）
- [ ] 可构造稳定的测试输入集

### S3: 需先解耦

**特征**：
- 无法稳定表征（行为不确定）
- 耦合导致不可控副作用
- 需要先引入 seam 才能测试

**后续路径**：Skill 07（设计 Seam）

**判定依据**：
- [ ] 存在无法控制的非确定性
- [ ] 深度耦合全局状态
- [ ] 副作用难以隔离或观测

### S4: 需人工判定

**特征**：
- 业务语义不清
- 行为"看起来像 bug 但可能是需求"
- Agent 无法独立判断正确性

**后续路径**：Skill 10（人工介入）

**判定依据**：
- [ ] 发现可疑行为但无文档支撑
- [ ] 边界条件处理逻辑不明确
- [ ] 多种解释都合理

---

## 门禁状态（G0-G3）

由门禁命令输出。

### G0: Green（绿灯）

**含义**：编译通过 + 测试通过 + 所有配置门禁通过

**后续**：继续当前流程

### G1: Build/Test Red（红灯-构建/测试）

**含义**：构建失败 或 测试失败

**后续**：
1. 立即停止当前操作
2. 回滚最近改动 或 修复问题
3. 重新运行门禁直至 G0

### G2: Behavior Drift（行为漂移）

**含义**：对外行为发生变化
- 输出结果变化
- 接口契约变化
- 日志/错误码变化
- 时序变化

**后续**：参考 [门禁失败决策](../decisions/gate-failure-decision.md)，执行 Skill 09

### G3: Flaky/Non-deterministic（不稳定）

**含义**：测试结果不一致
- 多次运行结果不同
- 数据竞争
- 时序依赖

**后续**：参考 [门禁失败决策](../decisions/gate-failure-decision.md)，执行 Skill 12

---

## 状态转换规则

### 评估状态到 Skill 的路径

| 评估状态 | 执行路径 | 最终汇合点 |
|----------|----------|------------|
| S1 | Skill 06 → Skill 08 | 运行门禁 |
| S2 | Skill 05 → Skill 07 → Skill 08 | 运行门禁 |
| S3 | Skill 07 → Skill 08 | 运行门禁 |
| S4 | Skill 10 → 重新评估 | 返回评估阶段 |

### 门禁结果处理

| 门禁状态 | 后续动作 |
|----------|----------|
| G0（绿灯） | 执行 Skill 11（文档更新） → 选择下一模块 |
| G1（红灯） | 回滚或修复 → 重新运行门禁 |
| G2（行为漂移） | Skill 09 判定 → 根据结论处理 → 重新运行门禁 |
| G3（不稳定） | Skill 12 治理 → 重新运行门禁 |

### 完整流程总结

1. 模块进入 Skill 04 评估，输出状态 S1/S2/S3/S4
2. 根据状态执行对应 Skill 序列
3. 执行完成后运行门禁
4. 门禁通过（G0）则更新文档并处理下一模块
5. 门禁失败则进入对应处理流程，修复后重新运行门禁

---

**下一步**：返回调用此文档的阶段/Skill 继续执行
