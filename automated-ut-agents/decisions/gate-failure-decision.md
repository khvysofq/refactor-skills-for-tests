# 门禁失败决策树

> **用途**：门禁执行失败后，根据失败类型选择处理路径  
> **触发**：运行门禁命令后返回非零/失败状态

---

## 决策规则总览

门禁执行完成后，根据结果状态选择对应处理路径：

| 门禁状态 | 状态含义 | 处理方式 | 后续动作 |
|----------|----------|----------|----------|
| G0 | 绿灯（通过） | 继续正常流程 | 执行 Skill 11 |
| G1 | 红灯（失败） | 分析失败类型 | 见 G1 子类型处理 |
| G2 | 行为漂移 | 行为差异判定 | 执行 Skill 09 |
| G3 | 不稳定 | 稳定性治理 | 执行 Skill 12 |

### G1 子类型处理

| 子类型 | 触发条件 | 处理方式 |
|--------|----------|----------|
| G1a 编译失败 | 编译错误 | 修复编译错误 |
| G1b 测试失败 | 测试断言失败 | 修复测试或回滚 |
| G1c 其他门禁 | Lint/Sanitizer 等失败 | 按具体门禁修复 |

**所有处理完成后**：重新运行门禁，直至达到 G0 状态。

---

## G0: 绿灯（通过）

### 识别方式

```bash
./tools/test.sh
# 返回值 = 0
# 所有测试通过
# 无错误输出
```

### 处理

无需处理，继续正常流程：
- 执行 Skill 11: 文档更新
- 或继续当前任务

---

## G1: 红灯（构建/测试失败）

### 识别方式

```bash
./tools/test.sh
# 返回值 ≠ 0
# 编译错误 或 测试断言失败
```

### 子类型判断

按以下顺序判断 G1 的具体类型：

| 步骤 | 检查条件 | 是 | 否 |
|------|----------|-----|-----|
| 1 | 编译失败？ | G1a: 编译错误 | 继续步骤 2 |
| 2 | 测试失败？ | G1b: 测试失败 | G1c: 其他门禁失败 |

### G1a: 编译错误

**处理流程**：

1. **查看编译错误信息**：`make 2>&1 | head -50`
2. **定位错误**：语法错误、缺失头文件、链接错误、类型不匹配
3. **修复**：
   - 如果是刚做的改动导致 → 修复或回滚
   - 如果是依赖问题 → 解决依赖
4. **重新编译验证**：`make && echo "Fixed"`

**常见原因**：

| 错误类型 | 示例 | 修复方法 |
|----------|------|----------|
| 语法错误 | missing `;` | 修复语法 |
| 头文件缺失 | file not found | 添加 include |
| 未定义符号 | undefined reference | 添加链接库 |
| 类型错误 | cannot convert | 修复类型 |

### G1b: 测试失败

**处理流程**：

1. **识别失败的测试**：`./run_tests 2>&1 | grep FAILED`
2. **分析失败原因**：期望值变化？实现逻辑错误？测试本身有问题？
3. **决策并处理**：
   - 最近改动导致 → 修复改动或回滚
   - 发现真实 bug → 记录，Skill 13 修复
   - 测试过度约束 → 调整测试（小心！）
4. **重新运行验证**：`./run_tests && echo "Fixed"`

**决策辅助表**：

| 问题 | 是 | 否 |
|------|-----|-----|
| 是刚做的改动导致？ | 改动有问题，修复或回滚 | 继续下一步分析 |
| 是新增的测试？ | 检查测试正确性 | 继续下一步分析 |
| 原有测试突然失败？ | 检查环境问题、依赖变化，可能是隐藏 bug 被触发 | - |

### G1c: 其他门禁失败

**可能的门禁**：

| 门禁 | 失败示例 | 处理 |
|------|----------|------|
| Lint | style error | 修复代码风格 |
| Sanitizer | memory leak | 修复内存问题 |
| Coverage | below threshold | 补充测试 |
| Static Analysis | warning | 修复警告 |

---

## G2: 行为漂移

### 识别方式

测试通过但输出/行为发生变化：
- Golden 测试检测到差异
- 日志/错误码变化
- 接口返回值变化
- 时序变化

### 处理流程

执行 **Skill 09: 行为差异判定**（路径: skills/skill-09-behavior-drift.md）

Skill 09 会输出三种结论之一：

| 结论 | 后续处理 |
|------|----------|
| 需求变更 | 更新测试/Golden，继续 |
| 真实 Bug | 执行 Skill 13 修复 |
| 测试过度约束 | 调整测试策略 |

### 快速判断

| 行为变化类型 | 通常结论 |
|--------------|----------|
| 格式变化（日志格式、序列化格式） | 测试过度约束 |
| 功能变化（结果不同） | 需要深入分析正确性 |
| 错误处理变化 | 可能是 bug 或需求变更 |

---

## G3: 不稳定

### 识别方式

测试结果不一致：
- 多次运行结果不同
- 偶发失败
- 超时/死锁

### 处理流程

执行 **Skill 12: 稳定性治理**（路径: skills/skill-12-stability.md）

**目标**：消除非确定性，确保测试稳定

### 快速诊断

```bash
# 重复运行检测
for i in {1..10}; do 
    ./run_tests --gtest_filter="*SuspectedFlaky*" || echo "Fail: $i"
done

# 如果有失败，确认是 G3
```

### 常见原因速查

| 症状 | 可能原因 | 解决方向 |
|------|----------|----------|
| 偶发超时 | 时间依赖 | 注入 Clock |
| 随机失败 | 随机数依赖 | 固定种子 |
| 顺序影响 | 测试间依赖 | 确保隔离 |
| 偶发死锁 | 并发问题 | 同步/单线程 |

---

## 快速处理流程

### 最短路径

| 情况 | 处理方式 |
|------|----------|
| 知道原因且能快速修复（<5分钟） | 立即修复 → 重新运行门禁 |
| 不确定原因 | 先回滚到上一个绿灯状态，再逐步定位问题 |
| 复杂问题 | 按上述流程进入对应 Skill |

### 回滚命令

```bash
# 回滚未提交的更改
git checkout -- .

# 回滚到上一个提交
git reset --hard HEAD~1

# 回滚到特定的已知好的提交
git reset --hard <known_good_commit>
```

---

## 门禁状态记录

在重构会话中记录：

```markdown
## 门禁记录

| 时间 | 状态 | 失败原因 | 处理 | 结果 |
|------|------|----------|------|------|
| 10:30 | G0 | - | - | ✓ |
| 11:00 | G1b | 测试断言失败 | 修复逻辑 | ✓ |
| 11:30 | G2 | 输出格式变化 | 更新 Golden | ✓ |
| 12:00 | G0 | - | - | ✓ |
```

---

## 常见问题

### Q: 门禁通过但不确定改动是否正确？

**A**: 增加测试覆盖，用测试验证正确性。如果不确定业务逻辑，执行 Skill 10 人工确认。

### Q: 回滚后门禁仍然失败？

**A**: 可能是环境问题或外部依赖变化：
1. 检查环境（编译器、依赖库版本）
2. 检查是否有并行修改
3. 检查外部服务状态

### Q: 多个门禁同时失败？

**A**: 按优先级处理：
1. 先解决编译失败（G1a）
2. 再解决测试失败（G1b）
3. 最后处理其他门禁

**注意**：通常编译失败会导致后续门禁都失败。
