# 全局约束定义

> **阅读时机**：执行任何代码改动前必须阅读并理解。

---

## 硬性约束（不可违背）

### C1: 行为不变性

**必须保持**：对外行为完全一致

**禁止**：未经确认改变任何可观测行为

**例外情况**：
- 被测试用例显式定义为变更
- 经人工确认的需求变更
- 确认为 Bug 的修复（需先写失败测试）

### C2: API/ABI 稳定性

**必须保持**：Public API/ABI 不变

**禁止**：未经 RFC 流程改变公共接口

**可修改范围**：
- 内部实现细节
- 私有函数/类
- 测试专用接口（命名空间隔离）

### C3: 持续可构建

**每次变更后必须**：可编译 + 测试通过 + 门禁通过

**禁止**：提交无法编译或测试失败的代码

### C4: 小步提交

**要求**：单 PR/单任务聚焦单模块或单切片

**禁止**：一次提交跨多个不相关模块的改动

---

## 门禁配置项（可按工程调整）

| 门禁 | 默认 | 可选 | 说明 |
|------|------|------|------|
| Build Gate | 必须 | - | 编译必须成功 |
| Test Gate | 必须 | - | 相关测试必须通过 |
| Stability Gate | 按需 | ✓ | 重复运行一致性检查 |
| Sanitizer Gate | 推荐 | ✓ | ASAN/UBSAN/TSAN |
| Coverage Gate | 可选 | ✓ | 覆盖率阈值 |
| Static Analysis | 可选 | ✓ | 静态分析规则集 |

---

## 变更流程约束

### 合法变更序列

1. 确认当前状态为绿灯（G0）
2. 进行单一局部改动
3. 运行最小门禁集
4. 确认仍为绿灯
5. 提交

### 遇到红灯时

门禁失败 → 立即停止 → 参考 [门禁失败决策](../decisions/gate-failure-decision.md)

---

## 检查清单

执行改动前确认：

- [ ] 改动范围是否在允许的模块内？
- [ ] 是否可能影响对外行为？
- [ ] 改动后能否快速验证（< 5 分钟门禁）？
- [ ] 如果失败，能否快速回滚？

---

**下一步**：返回调用此文档的阶段/Skill 继续执行
