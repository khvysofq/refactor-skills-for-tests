# 综合决策树

> **阅读时机**：遇到任何需要决策的分支点时  
> **目标**：确保所有可能的情况都有明确的处理路径

---

## 概述

本文档整合了工作流中所有的决策点，确保每个分支都有明确的处理逻辑，不存在遗漏的边界情况。

---

## 决策点索引

| ID | 决策点 | 位置 | 关联文档 |
|----|--------|------|----------|
| D01 | 入口决策 | 任务开始 | README.md |
| D02 | 可测试性决策 | Skill 04 后 | testability-decision.md |
| D03 | 门禁失败决策 | 门禁运行后 | gate-failure-decision.md |
| D04 | 行为差异决策 | Skill 09 中 | skill-09-behavior-drift.md |
| D05 | 人工介入决策 | Skill 10 中 | skill-10-human-input.md |
| D06 | 迭代继续决策 | 模块完成后 | 本文档 |
| D07 | 测试策略决策 | Skill 04/05/06 中 | 本文档 |
| D08 | Seam设计决策 | Skill 07 中 | 本文档 |
| D09 | 重构范围决策 | Skill 08 中 | 本文档 |
| D10 | 异常恢复决策 | 任意时刻 | 本文档 |

---

## D01: 入口决策

### 决策问题

工作流应该从哪个阶段开始？

### 决策树

```
项目是否有稳定的一键构建+测试命令？
├── 是 → 运行命令，是否绿灯？
│   ├── 是 → 是否有模块地图？
│   │   ├── 是 → 是否有优先级队列？
│   │   │   ├── 是 → 进入 Phase 04
│   │   │   └── 否 → 进入 Phase 03
│   │   └── 否 → 进入 Phase 02
│   └── 否 → 进入 Phase 01（修复基线）
└── 否 → 进入 Phase 01
```

### 边界情况

| 情况 | 处理 |
|------|------|
| 有构建命令但无测试命令 | Phase 01，补充测试框架 |
| 有测试但不稳定（偶发失败） | Phase 01，先稳定化 |
| 有旧的模块地图但已过时 | Phase 02，重新分析 |
| 有Backlog但格式不符 | Phase 03，重新生成 |

---

## D02: 可测试性决策

### 决策问题

模块应该走哪条测试路径？

### 决策树

```
模块边界是否清晰？
├── 是 → 依赖是否可替换？
│   ├── 是 → 状态 S1 → Skill 06（直接单测）
│   └── 否 → 是否有确定性输出？
│       ├── 是 → 状态 S2 → Skill 05（表征测试）
│       └── 否 → 状态 S3 → Skill 07（先解耦）
└── 否 → 业务逻辑是否清晰？
    ├── 是 → 状态 S3 → Skill 07（先解耦）
    └── 否 → 状态 S4 → Skill 10（人工介入）
```

### 边界情况

| 情况 | 状态 | 处理 |
|------|------|------|
| 边界清晰但有全局状态 | S3 | 先用Skill 07引入Seam |
| 有确定性输出但依赖时间 | S2→S3 | 先稳定化时间依赖 |
| 纯函数但缺少文档 | S1 | 直接单测，同时补文档 |
| 接口清晰但实现复杂 | S2 | 表征测试锁定行为 |
| 硬件依赖无法模拟 | S4 | 人工判断是否需要真机测试 |
| 并发代码 | S3 | 需要特殊处理，可能需人工 |

### 状态转换规则

| 初始状态 | 可转换到 | 条件 |
|----------|----------|------|
| S1 | - | 直接执行，无需转换 |
| S2 | S1 | 解耦后依赖可替换 |
| S3 | S1, S2 | 引入Seam后重新评估 |
| S4 | S1, S2, S3 | 人工澄清后重新评估 |

---

## D03: 门禁失败决策

### 决策问题

门禁失败后应该如何处理？

### 决策树

```
门禁失败类型？
├── G1: 编译失败
│   └── 是否是本次改动导致？
│       ├── 是 → 回滚改动，检查原因
│       └── 否 → 检查环境/依赖变化
├── G2: 行为漂移
│   └── 进入 Skill 09 判定
│       ├── 需求变更 → 更新测试/Golden
│       ├── 真实Bug → Skill 13 修复
│       └── 测试过度约束 → 调整测试
├── G3: 测试不稳定
│   └── 进入 Skill 12 稳定化
│       ├── 成功稳定 → 返回原流程
│       └── 无法稳定 → Skill 10 求助
└── G4: 超时/资源问题
    └── 检查资源使用
        ├── 测试本身问题 → 优化测试
        └── 环境问题 → 调整环境
```

### 边界情况

| 情况 | 处理 |
|------|------|
| 编译警告变错误 | 检查编译器版本/flags变化 |
| 链接失败 | 检查库依赖和符号 |
| 多个测试同时失败 | 可能是共享依赖问题 |
| 只在CI失败本地通过 | 环境差异，需要对齐 |
| 随机失败 | G3处理，稳定化 |
| 内存泄漏导致失败 | 修复泄漏，可能需要Valgrind |

### 回滚策略

| 失败严重程度 | 回滚策略 |
|--------------|----------|
| 单个测试失败 | 尝试修复，失败则回滚本次改动 |
| 多个测试失败 | 立即回滚，分析原因 |
| 编译失败 | 立即回滚 |
| 无法确定原因 | 回滚到上一个绿灯检查点 |

---

## D04: 行为差异决策

### 决策问题

检测到的行为差异应该如何分类和处理？

### 决策树

```
差异类型？
├── 格式变化（日志、序列化）
│   └── 是否影响功能？
│       ├── 是 → 可能是Bug
│       └── 否 → 测试过度约束
├── 数值变化
│   └── 是否在容差范围内？
│       ├── 是 → 测试过度约束，使用approx
│       └── 否 → 检查计算逻辑
│           ├── 新结果正确 → 需求变更
│           └── 新结果错误 → Bug
├── 错误处理变化
│   └── 错误类型/消息变化？
│       ├── 类型变化 → 可能是Bug或需求变更
│       └── 消息变化 → 通常是测试过度约束
├── 时序变化
│   └── 是否有顺序依赖？
│       ├── 是 → 需要分析正确性
│       └── 否 → 测试过度约束
└── 功能变化
    └── 是否预期？
        ├── 是 → 需求变更，需人工确认
        └── 否 → Bug
```

### 边界情况

| 情况 | 处理 |
|------|------|
| 无法判断正确性 | Skill 10 人工介入 |
| 多处同时变化 | 可能是底层依赖变化 |
| 变化是改进但未预期 | 记录为需求变更，需确认 |
| 测试本身有Bug | 修复测试 |

---

## D05: 人工介入决策

### 决策问题

何时需要人工介入？介入后如何继续？

### 需要人工介入的情况

| 情况 | 触发条件 | 问询内容 |
|------|----------|----------|
| 业务规则不清 | S4状态 | 边界条件、错误处理、业务逻辑 |
| 行为正确性不确定 | Skill 09 无法判定 | 期望行为是什么 |
| 架构决策 | Seam设计有多个方案 | 选择哪个方案 |
| 测试策略 | 无法确定测试粒度 | 测试到什么程度 |
| 遗留代码理解 | 代码意图不明 | 这段代码的目的 |

### 人工介入后的处理

```
收到人工回答？
├── 是 → 回答是否完整？
│   ├── 是 → 记录决策 → 转化为测试/文档 → 返回原流程
│   └── 否 → 追问补充
└── 否（超时/无响应）
    └── 是否有默认处理？
        ├── 是 → 使用默认处理，标记待确认
        └── 否 → 阻塞，等待回答
```

### 边界情况

| 情况 | 处理 |
|------|------|
| 回答模糊 | 提供具体选项再次确认 |
| 回答与代码矛盾 | 指出矛盾，请求澄清 |
| 多人回答不一致 | 升级到决策者 |
| 长时间无响应 | 标记阻塞，处理其他模块 |

---

## D06: 迭代继续决策

### 决策问题

当前模块完成后，下一步做什么？

### 决策树

```
当前模块门禁是否通过？
├── 是 → 文档是否已更新？
│   ├── 是 → Backlog是否还有待处理模块？
│   │   ├── 是 → 是否有阻塞模块可以解除？
│   │   │   ├── 是 → 优先处理解除阻塞的模块
│   │   │   └── 否 → 选择下一个最高优先级模块
│   │   └── 否 → 生成最终报告，结束
│   └── 否 → Skill 11 更新文档
└── 否 → 根据门禁状态进入 D03
```

### 模块选择策略

| 条件 | 选择策略 |
|------|----------|
| 正常情况 | 选择Backlog中最高优先级的Todo模块 |
| 有依赖关系 | 优先处理被依赖的模块 |
| 有阻塞模块 | 检查阻塞是否可解除 |
| 时间紧迫 | 选择预估时间短的模块 |
| 需要打样 | 选择S1状态的简单模块 |

### 边界情况

| 情况 | 处理 |
|------|------|
| 所有剩余模块都是S4 | 批量人工介入 |
| 循环依赖模块 | 作为一组同时处理 |
| 模块优先级相同 | 选择复杂度低的 |
| 发现新模块 | 加入Backlog，重新评估优先级 |

---

## D07: 测试策略决策

### 决策问题

应该使用什么测试策略？

### 决策树

```
模块类型？
├── 纯函数/工具类
│   └── L1 单元测试为主
├── 业务逻辑
│   └── 边界是否清晰？
│       ├── 是 → L1 + L2
│       └── 否 → L2 表征测试
├── I/O 操作
│   └── 可以mock？
│       ├── 是 → L1 + mock
│       └── 否 → L2 + 真实资源
├── 状态机
│   └── L1 状态转换测试 + L2 场景测试
└── 并发代码
    └── L1 核心逻辑 + 专门的并发测试
```

### 测试覆盖目标

| 模块类型 | L1覆盖率目标 | L2场景数 |
|----------|--------------|----------|
| 核心业务 | ≥80% | ≥10 |
| 工具类 | ≥90% | ≥5 |
| I/O操作 | ≥60% | ≥5 |
| 遗留代码 | ≥50% | ≥10 |

### 边界情况

| 情况 | 处理 |
|------|------|
| 无法达到覆盖率目标 | 记录原因，设置实际可达目标 |
| 测试成本过高 | 优先覆盖高风险路径 |
| 代码不可测 | 先重构使其可测 |

---

## D08: Seam设计决策

### 决策问题

应该在哪里引入Seam？使用什么类型？

### 决策树

```
依赖类型？
├── 时间/时钟
│   └── 引入 IClock 接口
├── 文件系统
│   └── 引入 IFileSystem 接口
├── 网络
│   └── 引入 IHttpClient / ISocket 接口
├── 数据库
│   └── 引入 IRepository 接口
├── 随机数
│   └── 引入 IRandomGenerator 接口
├── 全局状态
│   └── 转为依赖注入
├── 硬件
│   └── 引入 IHardwareDriver 接口
└── 第三方库
    └── 引入适配器层
```

### Seam类型选择

| Seam类型 | 适用场景 | 侵入性 |
|----------|----------|--------|
| 接口抽取 | 依赖可抽象 | 中 |
| 构造函数注入 | 新代码或可修改 | 低 |
| Setter注入 | 需要运行时切换 | 低 |
| 模板参数 | 编译时确定 | 低 |
| 链接时替换 | 无法修改源码 | 高 |
| 预处理器宏 | 遗留代码 | 高 |

### 边界情况

| 情况 | 处理 |
|------|------|
| 依赖过多 | 考虑引入Facade |
| 接口过大 | 接口隔离，拆分 |
| 循环依赖 | 引入中间层 |
| 性能敏感 | 考虑编译时多态 |

---

## D09: 重构范围决策

### 决策问题

本次重构应该改多少？

### 决策树

```
改动目的？
├── 提高可测试性
│   └── 最小改动原则
│       ├── 只改必要的部分
│       └── 不改变外部API
├── 修复Bug
│   └── 先红后绿
│       ├── 先写失败测试
│       └── 最小改动修复
├── 性能优化
│   └── 有测试覆盖后再改
└── 代码清理
    └── 确保测试覆盖后再改
```

### 改动大小判断

| 指标 | 小步 | 中步 | 大步（需拆分） |
|------|------|------|----------------|
| 代码行数 | <50 | 50-200 | >200 |
| 文件数 | 1-2 | 3-5 | >5 |
| 时间 | <5分钟 | 5-30分钟 | >30分钟 |
| API变化 | 无 | 内部 | 外部 |

### 边界情况

| 情况 | 处理 |
|------|------|
| 改动无法拆小 | 增加测试覆盖后再改 |
| 发现更大问题 | 记录，不在本次处理 |
| 改动引发连锁 | 评估影响，可能需要重新规划 |

---

## D10: 异常恢复决策

### 决策问题

遇到异常情况如何恢复？

### 异常类型与处理

```
异常类型？
├── 环境问题
│   ├── 编译器版本不匹配 → 对齐版本
│   ├── 依赖缺失 → 安装依赖
│   └── 磁盘/内存不足 → 清理/扩容
├── 工具问题
│   ├── 静态分析工具失败 → 检查配置，跳过或修复
│   ├── 测试框架问题 → 检查版本兼容性
│   └── 脚本错误 → 修复脚本
├── 代码问题
│   ├── 无法编译 → 回滚到上一个绿灯
│   ├── 测试全部失败 → 检查测试环境
│   └── 死循环/卡死 → 超时机制，强制终止
├── 流程问题
│   ├── 状态文件损坏 → 从检查点恢复
│   ├── 文档不一致 → 以代码为准，更新文档
│   └── 决策冲突 → 人工介入
└── 外部问题
    ├── 网络中断 → 重试或离线模式
    ├── 服务不可用 → 等待或使用备用
    └── 权限问题 → 请求权限
```

### 恢复优先级

| 优先级 | 恢复策略 |
|--------|----------|
| 1 | 尝试自动修复 |
| 2 | 回滚到上一个稳定状态 |
| 3 | 从检查点恢复 |
| 4 | 人工介入 |
| 5 | 重新开始当前阶段 |

### 边界情况

| 情况 | 处理 |
|------|------|
| 多个异常同时发生 | 按优先级逐个处理 |
| 异常原因不明 | 收集日志，人工分析 |
| 恢复后再次失败 | 升级处理策略 |
| 无法恢复 | 记录状态，等待人工 |

---

## 决策记录模板

当做出重要决策时，使用以下模板记录：

```markdown
# 决策记录: <决策标题>

> 日期: YYYY-MM-DD
> 决策点: D0X
> 模块: <模块名>

## 背景

<为什么需要做这个决策>

## 选项

| 选项 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| A | | | |
| B | | | |
| C | | | |

## 决策

选择: <选项>

理由: <为什么选择这个>

## 影响

- 对测试的影响: 
- 对代码的影响: 
- 对进度的影响: 

## 后续行动

1. [ ] 
2. [ ] 
```

---

**下一步**：根据当前决策点，执行对应的处理流程
