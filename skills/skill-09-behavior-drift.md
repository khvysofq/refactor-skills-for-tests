# Skill 09: 行为差异判定与处理

> **触发条件**：门禁判定为 G2 Behavior Drift  
> **目标**：定位行为变化原因，给出处置决策

---

## 输入

- 门禁失败报告
- 变化前后的输出对比

---

## 输出

| 产出 | 说明 | 必须 |
|------|------|------|
| 差异分析报告 | 变化原因和处置决策 | ✓ |
| 后续行动 | 更新测试 / 修复 bug / 回滚 | ✓ |

---

## 核心任务

### 任务 1: 收集差异证据

**收集内容**：

| 类别 | 收集项 |
|------|--------|
| 测试失败信息 | 哪个测试失败、期望值 vs 实际值、失败位置 |
| 代码变更 | 最近的 commit、变更的文件和行 |
| 输出差异 | 返回值变化、错误码变化、日志变化、时序变化 |

**收集命令**：

```bash
# 查看最近变更
git diff HEAD~1

# 查看测试失败详情
./run_tests --gtest_filter="*FailingTest*" 2>&1 | tee failure.log

# 对比 Golden 数据差异
diff tests/characterization/golden/expected.txt actual.txt
```

### 任务 2: 定位差异来源

**差异分类与处理**：

| 差异类型 | 子类型 | 通常结论 |
|----------|--------|----------|
| 格式变化 | 日志格式、序列化格式 | 测试过度约束 |
| 数值变化 | 浮点精度 | 测试问题，使用 approx |
| 数值变化 | 计算结果、边界值 | 需要判断正确性 |
| 错误码/异常变化 | 错误类型变化 | 可能是 bug 或需求变更 |
| 错误码/异常变化 | 错误消息变化 | 通常是测试过度约束 |
| 时序变化 | 顺序变化 | 检查是否有顺序依赖 |
| 时序变化 | 时间戳变化 | 通常是非确定性 |
| 功能变化 | - | 需要深入分析 |

### 任务 3: 判定差异性质

**三类结论**：

#### A. 需求变更

**特征**：
- 变化是预期的行为改进
- 旧行为有问题或不合理
- 新行为更符合需求

**处理**：需要人工确认 → 更新测试用例/Golden 数据 → 记录变更原因

#### B. 真实 Bug

**特征**：
- 变化破坏了预期功能
- 引入了错误行为
- 违反了接口契约

**处理**：跳转到 Skill 13 → 先写失败测试 → 修复后验证

#### C. 测试过度约束

**特征**：
- 测试断言了不应该断言的内容
- 测试依赖了实现细节
- 测试对非确定性内容做了确定性断言

**处理**：调整测试策略 → 使用更宽松的断言 → 过滤/normalize 非关键输出

### 任务 4: 执行处置

**处置流程**：

| 判定结论 | 处置步骤 |
|----------|----------|
| A. 需求变更 | 1. 需要人工确认？是 → Skill 10 问询；否 → 直接更新<br>2. 更新测试/Golden：`./tools/update_golden.sh <module>`<br>3. 提交：`git commit -m "update: golden data for <reason>"` |
| B. 真实 Bug | 跳转 Skill 13 修复 |
| C. 测试过度约束 | 1. 调整断言方式（EXPECT_EQ → EXPECT_THAT 等）<br>2. 添加 normalize 处理（过滤时间戳、忽略无关字段） |

---

## 差异分析报告模板

```markdown
# 行为差异分析报告

## 基本信息
- 模块: <module>
- 日期: YYYY-MM-DD
- 触发: <测试名称或门禁>

## 差异描述

### 期望行为
```
<期望的输出>
```

### 实际行为
```
<实际的输出>
```

### 差异点
1. xxx 字段从 A 变为 B
2. yyy 顺序发生变化

## 分析

### 变更来源
- 相关 commit: <hash>
- 变更文件: <files>
- 变更内容: <description>

### 差异原因
<分析为什么会产生这个差异>

## 判定

### 结论: [需求变更 / 真实Bug / 测试过度约束]

### 理由
<为什么做出这个判定>

## 处置

### 行动
- [ ] 更新 Golden 数据
- [ ] 修复代码
- [ ] 调整测试

### 后续
<下一步操作>
```

---

## 验收标准

### 必须满足

- [ ] 差异原因已定位
- [ ] 判定结论明确（A/B/C）
- [ ] 处置行动已执行
- [ ] 门禁恢复绿灯（或转入其他 Skill）

### 验收检查

```bash
# 门禁恢复
./tools/test.sh && echo "PASS" || echo "Still in progress"
```

---

## 应该做

- ✓ 保留差异证据
- ✓ 记录判定理由
- ✓ 小心更新 Golden（确认后再更新）
- ✓ 对于不确定的判定，请求人工介入

## 不应该做

- ✗ 盲目更新 Golden 数据
- ✗ 删除失败的测试
- ✗ 忽略差异继续前进
- ✗ 在不理解原因的情况下做判定

---

## 状态跳转

根据判定结论选择下一步：

| 判定结论 | 下一步 |
|----------|--------|
| 需求变更（已确认） | 更新测试后返回 [Skill 08](skill-08-refactor.md) |
| 需求变更（需确认） | [Skill 10: 人工介入](skill-10-human-input.md) |
| 真实 Bug | [Skill 13: 缺陷修复](skill-13-bugfix.md) |
| 测试过度约束 | 调整测试后返回 [Skill 08](skill-08-refactor.md) |

---

## 时间预估

| 差异复杂度 | 预估时间 |
|------------|----------|
| 简单（格式变化） | 15 - 30 分钟 |
| 中等（逻辑变化） | 30 - 60 分钟 |
| 复杂（需要深入分析） | 1 - 2 小时 |

---

**完成后**：根据判定结论跳转到对应 Skill
