# Skill 03: 模块分级与优先级队列

> **触发条件**：Phase 03 指示  
> **目标**：确定模块处理顺序，最大化收益并降低失败风险

---

## 输入

- Skill 02 产出的模块地图
- 对工程的整体理解

---

## 输出

| 产出 | 路径 | 必须 |
|------|------|------|
| 测试待办队列 | `docs/testing/backlog.md` | ✓ |

---

## 核心任务

### 任务 1: 模块评分

**目标**：为每个模块计算优先级分数

**评分公式**：

```
优先级分 = (收益分 × 可测性分) / 风险分
```

#### 收益分（1-5）

| 因素 | 5 分 | 3 分 | 1 分 |
|------|------|------|------|
| 改动频率 | 每周多次 | 每月几次 | 很少改动 |
| 业务重要性 | 核心功能 | 重要功能 | 边缘功能 |
| Bug 历史 | 频繁出问题 | 偶尔出问题 | 稳定 |
| 被依赖程度 | 10+ 模块依赖 | 3-10 模块依赖 | <3 模块依赖 |

**评估方法**：

```bash
# 改动频率（Git 历史）
git log --oneline --since="6 months ago" -- <module_path> | wc -l

# 被依赖程度
grep -r "#include.*<module>" src/ | wc -l
```

#### 可测性预估分（1-5）

| 因素 | 5 分 | 3 分 | 1 分 |
|------|------|------|------|
| 外部依赖 | 无 | 可控 | 复杂 |
| 边界清晰度 | 接口明确 | 部分明确 | 模糊 |
| 确定性 | 纯函数 | 有状态但可控 | 并发/随机 |
| 代码质量 | 结构清晰 | 一般 | 混乱 |

**预估状态**：

| 可测性分 | 预估状态 |
|----------|----------|
| 5 分 | S1（可直接单测） |
| 3-4 分 | S2（可表征） |
| 2 分 | S3（需解耦） |
| 1 分 | S3/S4（高风险或需人工判定） |

#### 风险分（1-5，越低越好）

| 因素 | 1 分（低风险） | 3 分 | 5 分（高风险） |
|------|----------------|------|----------------|
| 耦合度 | 完全解耦 | 部分耦合 | 全局状态 |
| 并发 | 单线程 | 受控并发 | 复杂多线程 |
| 硬件依赖 | 纯软件 | 可模拟 | 需真实硬件 |
| 重构难度 | 小调整 | 中等改动 | 大规模重构 |

### 任务 2: 排序与分组

**目标**：形成优先级队列

**排序规则**：

1. 计算每个模块的优先级分
2. 按分数降序排列
3. 分组：P1（高优先级）≥15 分；P2（中优先级）8-14 分；P3（低优先级）<8 分
4. 在 P1 中，优先选择 S1/S2 模块作为"打样"

**特殊处理**：

| 情况 | 处理方式 |
|------|----------|
| P1 全是高风险模块 | 从 P2 中选一个低风险模块先打样 |
| 发现循环依赖 | 需要一起处理的模块归为一组 |

### 任务 3: 制定策略

**目标**：为每个模块指定测试策略

**策略决策**：

| 预估状态 | 测试策略 |
|----------|----------|
| S1 | L1 为主 |
| S2 | L1 + L2 |
| S3 | L2 为主（解耦后可升级到 L1） |
| S4 | 需先人工判定 |

---

## 输出格式

### Backlog 文档模板

使用 [Backlog 条目模板](../templates/backlog-entry.md)。

```markdown
# 测试待办队列

> 更新日期：YYYY-MM-DD

## 统计

- 总模块数：N
- P1 模块：X
- P2 模块：Y
- P3 模块：Z

## P1: 高优先级

| # | 模块 | 预估状态 | 策略 | 评分 | 状态 | 备注 |
|---|------|----------|------|------|------|------|
| 1 | core/utils | S1 | L1 | 25 | Todo | 快速胜利，建议首选 |
| 2 | core/parser | S2 | L1+L2 | 20 | Todo | 核心模块 |
| 3 | service/handler | S2 | L2 | 18 | Todo | |

## P2: 中优先级

| # | 模块 | 预估状态 | 策略 | 评分 | 状态 | 备注 |
|---|------|----------|------|------|------|------|
| 4 | io/file | S2 | L2 | 12 | Todo | I/O 依赖 |
| 5 | net/http | S3 | L2 | 10 | Todo | 需要解耦 |

## P3: 低优先级

| # | 模块 | 预估状态 | 策略 | 评分 | 状态 | 备注 |
|---|------|----------|------|------|------|------|
| 6 | driver/hw | S3 | L3 | 5 | Todo | 硬件依赖 |
| 7 | legacy/old | S4 | - | 3 | Todo | 业务不清 |

## 处理建议

### 第一批（打样，建立信心）
1. core/utils - 预计 2 小时
2. core/parser - 预计 4 小时

### 第二批（核心模块）
3. service/handler - 预计 4 小时
4. io/file - 预计 3 小时

### 后续批次
根据资源和进度调整
```

---

## 验收标准

### 必须满足

- [ ] Backlog 文档存在
- [ ] 至少 10 个可执行条目（或覆盖所有关键模块）
- [ ] 每个条目有：预估状态、策略、评分
- [ ] 有明确的执行顺序建议

### 验收检查

```bash
# 文档存在
[ -f docs/testing/backlog.md ] && echo "PASS" || echo "FAIL"

# 条目数量
grep -c "| .* | S[1-4] |" docs/testing/backlog.md
# 应该 >= 10
```

---

## 应该做

- ✓ 基于数据评分（Git 历史、依赖分析）
- ✓ 保守估计风险（宁高勿低）
- ✓ 预留"快速胜利"模块打样
- ✓ 标注不确定的地方

## 不应该做

- ✗ 主观偏好影响排序
- ✗ 把所有高风险模块排在前面
- ✗ 忽略评分直接排序
- ✗ 追求一次完美（后续可调整）

---

## 状态跳转

| 验收结果 | 下一步 |
|----------|--------|
| 通过 | 返回 [Phase 03](../phases/03-prioritization.md) 完成验收，然后进入 [Phase 04](../phases/04-iteration.md) |
| 未通过 - 条目不足 | 检查是否遗漏模块 |
| 未通过 - 评分不合理 | 重新评估 |
| 未通过 - 策略不清 | 参考测试分层定义 |

---

## 时间预估

| 工程规模 | 预估时间 |
|----------|----------|
| 小型（<10 模块） | 30 分钟 - 1 小时 |
| 中型（10-50 模块） | 1 - 2 小时 |
| 大型（>50 模块） | 2 - 4 小时 |

---

**完成后**：返回 [Phase 03](../phases/03-prioritization.md) 进行阶段验收
