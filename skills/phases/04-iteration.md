# Phase 04: 迭代循环

> **前置条件**：Phase 03 完成（优先级队列已建立）  
> **目标**：逐模块执行可测试性重构，建立测试体系

---

## 进入条件

- Phase 03 验收通过
- 或从 [README](../README.md) 决策树判断需要执行此阶段

---

## 迭代主循环

每个模块按以下步骤处理，循环执行直到队列清空：

| 步骤 | 动作 | 条件分支 |
|------|------|----------|
| 1 | 从 Backlog 选择下一个模块 | 队列为空？→ 结束，生成最终报告 |
| 2 | 执行 Skill 04: 可测试性评估 | 输出状态 S1/S2/S3/S4 |
| 3 | 根据评估状态选择路径 | 见下方"单模块处理路径" |
| 4 | 执行对应 Skill 序列 | - |
| 5 | 运行门禁检查 | G0 → 步骤 6；G1/G2/G3 → 故障处理后重试 |
| 6 | 更新 Backlog 状态，执行 Skill 11 | - |
| 7 | 返回步骤 1 | - |

---

## 单模块处理路径

### 评估状态到 Skill 序列映射

| 评估状态 | Skill 执行序列 | 汇合点 |
|----------|----------------|--------|
| S1（可直接单测） | Skill 06 → Skill 08 | 运行门禁 |
| S2（可表征） | Skill 05 → Skill 07 → Skill 08 | 运行门禁 |
| S3（需先解耦） | Skill 07 → Skill 08 | 运行门禁 |
| S4（需人工判定） | Skill 10 → 重新评估（返回 Step 2） | - |

### 门禁结果处理

| 门禁结果 | 处理方式 | 后续 |
|----------|----------|------|
| G0（绿灯） | 执行 Skill 11 文档更新 | 选择下一模块 |
| G1（红灯） | 回滚或修复 | 重新运行门禁 |
| G2（行为漂移） | 参考门禁失败决策 | 处理后重新运行门禁 |
| G3（不稳定） | 参考门禁失败决策 | 处理后重新运行门禁 |

**所有路径最终汇合**：门禁通过后执行 Skill 11，然后选择下一模块。

---

## 步骤详解

### Step 1: 选择下一个模块

1. 打开 `docs/testing/backlog.md`
2. 找到状态为 "Todo" 的最高优先级条目
3. 将其状态更新为 "Doing"
4. 记录模块名称，进入 Step 2

**队列为空时**：
- 所有模块已处理完成
- 执行 [最终报告生成](#最终报告生成)

### Step 2: 可测试性评估

**执行**：加载并执行 [Skill 04: 模块可测试性评估](../skills/skill-04-assessment.md)

**输出**：
- 模块卡片：`docs/testing/modules/<module>.md`
- 评估状态：S1 / S2 / S3 / S4

### Step 3: 路径选择

根据 Step 2 输出的状态，参考 [可测试性决策](../decisions/testability-decision.md)：

| 状态 | 下一步 |
|------|--------|
| S1 | → [Skill 06](../skills/skill-06-unit-tests.md)（直接单测） |
| S2 | → [Skill 05](../skills/skill-05-characterization.md)（表征测试） |
| S3 | → [Skill 07](../skills/skill-07-seams.md)（设计 Seam） |
| S4 | → [Skill 10](../skills/skill-10-human-input.md)（人工介入） |

### Step 4: 执行 Skill 序列

按路径依次执行对应 Skill，每个 Skill 完成后验证其验收标准。

**典型序列**：

| 路径 | Skill 序列 |
|------|------------|
| S1 路径 | Skill 06 → Skill 08 → 门禁 |
| S2 路径 | Skill 05 → Skill 07 → Skill 08 → 门禁 |
| S3 路径 | Skill 07 → Skill 08 → 门禁 |
| S4 路径 | Skill 10 → 返回 Step 2 重新评估 |

### Step 5: 门禁检查

运行门禁命令，根据结果：

| 结果 | 处理 |
|------|------|
| G0 Green | → Step 6（继续） |
| G1 Red | 回滚或修复，重试门禁 |
| G2 Drift | → [门禁失败决策](../decisions/gate-failure-decision.md) |
| G3 Flaky | → [Skill 12](../skills/skill-12-stability.md) |

### Step 6: 文档更新

**执行**：[Skill 11: 文档更新](../skills/skill-11-documentation.md)

- 更新模块卡片
- 更新 Backlog 状态为 "Done"
- 记录经验和注意事项

### Step 7: 继续循环

返回 Step 1，选择下一个模块。

---

## 门禁失败处理

遇到门禁失败时，参考 [门禁失败决策](../decisions/gate-failure-decision.md)。

快速参考：

| 门禁状态 | 处理步骤 |
|----------|----------|
| G1（构建/测试失败） | 1. 回滚最近改动或定位修复问题；2. 重试门禁 |
| G2（行为漂移） | 1. Skill 09 判定；2. 根据结论处理（需求变更→更新测试；真实Bug→Skill 13修复；无法判定→Skill 10问询）；3. 重试门禁 |
| G3（不稳定） | 1. Skill 12 稳定性治理；2. 修复后重试门禁 |

---

## 最终报告生成

当 Backlog 队列清空时：

### 生成内容

```markdown
# 可测试性重构报告

## 概要
- 处理模块数：X
- 测试覆盖率：Y%
- 发现缺陷数：Z

## 模块状态汇总
| 模块 | 最终状态 | 测试层级 | 覆盖率 |
|------|----------|----------|--------|
| ... | Done | L1 | 85% |

## 引入的 Seam
- 模块A：Clock 接口
- 模块B：FileSystem 接口

## 遗留问题
- 模块X：需要硬件测试环境
- 模块Y：部分逻辑无法判定

## 经验总结
- ...
```

### 输出位置

`docs/testing/final_report.md`

---

## 进度跟踪

### Backlog 状态

| 状态 | 含义 |
|------|------|
| Todo | 待处理 |
| Doing | 处理中 |
| Blocked | 阻塞（需人工/外部） |
| Done | 完成 |
| Skipped | 跳过（有理由） |

### 每日检查点

| 检查项 | 填写 |
|--------|------|
| 当前处理模块 | ____ |
| 当前步骤 | ____ |
| 是否有阻塞 | ____ |
| 预计完成时间 | ____ |

---

**开始**：从 `docs/testing/backlog.md` 选择第一个模块，执行 Step 2
