# 产出路径与报告结构约定

> **阅读时机**：Phase 04 或撰写/检查报告时；后续工作流按需引用时参阅「下游 Agent 使用约定」。

---

## 产出路径

所有产出均位于工程根目录下的 `docs/codearch/`（相对仓库根）。

| 产出 | 路径 | 说明 |
|------|------|------|
| 总体报告 | `docs/codearch/overall_report.md` | 工程概览、模块列表（含链接）、构建/测试摘要 |
| 模块报告 | `docs/codearch/modules/<module_name>.md` | 单模块报告，`<module_name>` 为模块标识（如目录名或 target 名，不含空格） |
| 构建与测试 | `docs/codearch/build_and_tests.md` | 编译系统、单元测试体系、运行测试方式 |
| 模块地图（可选） | `docs/codearch/module_map.md` | 模块列表与依赖图汇总，可与总体报告合并或独立 |

---

## 总体报告必须包含的章节

1. **工程名称与分析日期**（文档头部）  
   - **分析范围/版本**（可选但建议）：仓库 commit/tag、分析范围（如全库或子路径），供下游 Agent 判断报告是否仍适用于当前代码。  
2. **工程概览**  
   - 工程目标（主要做什么）  
   - 输入（配置、文件、命令行、网络等）  
   - 输出（结果文件、服务响应、日志等）  
   - 主流程（步骤列表或流程图）  
3. **技术特征概览**（为下游风险分析提供全局视图）  
   - 语言与标准（主要语言、语言标准、主要依赖库）  
   - 技术特征统计（各技术特征涉及的模块数和主要模块）  
   - 入口点索引（main() 位置、网络入口、配置入口等）  
4. **模块列表**  
   - 每个模块一行或表格行，包含：模块名、**路径/范围**（该模块对应的目录或 glob，如 `src/core/`、`src/parser/*.cpp`）、复杂度等级、**指向该模块报告的链接**  
   - 路径/范围便于「代码路径 → 模块 → 报告」的按需加载。  
   - 链接格式：相对路径 `modules/<module_name>.md`，例如 `[core/utils](modules/core_utils.md)`  
   - 可选：模块可含固定键（如 `role: lib|service|driver`），便于按角色过滤而无需打开每份报告。  
5. **构建与测试摘要**  
   - 简要说明或直接链接到 `build_and_tests.md`  
6. **后续分析建议**（可选）  

---

## 模块报告必须包含的章节

1. **模块名与路径**（文档头部）  
2. **职责描述**  
3. **边界**  
   - 输入  
   - 输出  
4. **依赖**  
   - 内部依赖（其他模块）  
   - 外部依赖（系统调用、库、I/O 等）  
5. **复杂度评级**  
   - 等级：低 / 中 / 高 / 极高  
   - 可选：简要依据  
6. **关键设计要点**（建议必填）  
   - 3–5 条要点，如：主要入口函数/类、核心数据结构、线程/并发假设、错误处理策略、扩展点等；供后续代码审查与重构 Agent 快速建立上下文。  
7. **代码特征**（必填，为下游风险分析提供索引）  
   - 内存管理：方式（RAII/智能指针/手动/混合）+ 简要说明  
   - 并发模型：是否多线程 + 同步机制 + 简要说明  
   - I/O 操作：文件 I/O、网络 I/O（是/否）+ 简要说明  
   - 外部数据处理：是否处理外部输入 + 数据来源 + 简要说明  
   - 错误处理：策略（返回错误码/异常/混合）+ 简要说明  
8. **关键代码位置索引**（必填）  
   - 主要入口点（函数/类、位置、说明）  
   - 外部数据入口（若有）  
9. **与其它模块的关系**（文字或依赖方向说明，可选 Mermaid 图）  

不包含可测试性状态（如 S1–S4）、测试策略等重构专用字段，保持纯架构分析。代码特征只记录客观事实，不做风险判断。

---

## 引用格式

- 在总体报告中引用模块报告：使用 Markdown 链接 `[模块名](modules/<module_name>.md)`。  
- 模块名中的路径分隔符建议统一为下划线或短横线（如 `core_utils` 或 `core-utils`），与文件名一致，便于后续 Agent 按需加载单份文件。

---

## 下游 Agent 使用约定

供后续工作流（代码审查、风险分析、重构、写测试等）在按需引用本产出时使用：

- **何时只读总体报告**：建立全局印象、选择模块、判断分析范围/版本是否仍适用（结合头部分析范围/版本与当前仓库 commit）。  
- **何时使用技术特征概览**：风险分析时，根据「技术特征统计」快速定位涉及特定技术（如多线程、外部输入处理）的模块，确定分析优先级。  
- **何时按需加载模块报告**：分析、审查或重构涉及某模块时；根据总体报告中「模块列表」的 **路径/范围** 列，由当前文件路径定位应加载的 `modules/<name>.md`。  
- **如何使用代码特征**：风险分析 Agent 可根据模块报告的「代码特征」章节，快速判断该模块是否涉及特定风险点（如手动内存管理、外部输入处理），决定是否深入审查。  
- **推荐用法**：进行风险分析或深度审查时，先加载 `overall_report.md` 查看技术特征概览，再根据改动涉及的文件/路径加载对应的 `modules/*.md`；利用「代码特征」和「关键代码位置索引」快速定位需要关注的代码区域。

---

## Agent 解析约定

- **固定标题**：总体报告与模块报告的必须章节使用固定标题（如 `## 工程概览`、`## 关键设计要点`、`## 职责描述`），便于 Agent 按标题解析。  
- **YAML frontmatter**（可选）：允许在报告头部使用 YAML frontmatter 提供摘要字段。  
  - 总体报告：如 `summary`、`scope_commit`、`module_count`，供 Agent 做轻量解析或 embedding。  
  - 模块报告：如 `summary`、`complexity`、`path`，便于先扫再决定是否读全文。  
  - 格式与用途在模板中简要说明即可。

---

**下一步**：返回 [Skill 04](../skills/skill-04-reports.md) 或 [Phase 04](../phases/04-reports.md)，按此结构生成或检查报告。
