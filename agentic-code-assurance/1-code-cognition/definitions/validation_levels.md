# 模块验证等级定义

> **阅读时机**：进行模块验证时（执行 Skill 02 Task 2.5 或需要确认模块理解时）。

---

## 等级概览

| 等级 | 名称       | 触发条件                 | 验证方式                 |
| ---- | ---------- | ------------------------ | ------------------------ |
| L0   | 无需验证   | 复杂度「低」             | 静态分析即可             |
| L1   | 阅读测试   | 复杂度「中」且有现有测试 | 阅读现有单元测试理解模块 |
| L2   | 运行测试   | 复杂度「高」             | 运行现有测试并分析输出   |
| L3   | 探索性测试 | 复杂度「极高」或测试不足 | 编写简单测试验证关键假设 |

---

## 验证前置条件

执行 L2 或 L3 验证前，必须满足以下条件：

- [ ] Phase 03（构建与测试体系）已完成，或至少已文档化构建和测试运行方式
- [ ] 构建环境可用（能够编译项目）
- [ ] 测试框架已识别（Google Test、Catch2 等）

**若前置条件不满足**：先跳转执行 [Phase 03](1-code-cognition/phases/03-build-and-tests.md)，完成后返回继续验证。

---

## L0: 无需验证

**触发条件**：模块复杂度为「低」

**说明**：

- 模块代码量小、依赖少、无外部 I/O
- 静态代码分析已足够理解模块功能
- 无需额外验证步骤

**产出**：在模块报告「验证状态」中写「L0 - 静态分析」或省略该章节。

---

## L1: 阅读测试验证

**触发条件**：模块复杂度为「中」且存在对应的单元测试

**目的**：通过阅读测试代码补充对模块的理解

**步骤**：

1. **定位测试文件**

   ```bash
   # 查找模块对应的测试文件
   find test/ tests/ -name "*<module>*" -o -name "*<Module>*" 2>/dev/null
   ls test/*<module>*.cpp tests/*<module>*.cpp 2>/dev/null
   ```

2. **提取测试用例名称**

   ```bash
   # Google Test 格式
   grep -E "TEST\(|TEST_F\(|TEST_P\(" test/*<module>*.cpp 2>/dev/null

   # Catch2 格式
   grep -E "TEST_CASE\(|SCENARIO\(" test/*<module>*.cpp 2>/dev/null
   ```

3. **阅读关键测试实现**

   - 选择 3–5 个代表性测试用例
   - 理解模块的典型使用方式
   - 识别输入/输出的具体形式
   - 了解边界条件和错误处理

4. **更新模块报告**
   - 在「关键设计要点」中补充测试揭示的细节
   - 在「使用示例」中引用测试代码片段

**产出**：

- 在模块报告「验证状态」中记录：
  - 验证等级：L1
  - 验证方式：阅读测试
  - 阅读的测试文件路径
  - 主要发现（2–3 条）

---

## L2: 运行测试验证

**触发条件**：模块复杂度为「高」

**目的**：通过执行测试确认对模块行为的理解

**步骤**：

1. **确认测试可执行**

   ```bash
   # 检查测试 target 是否存在
   grep -r "add_test\|gtest_discover_tests" . --include="CMakeLists.txt" | grep -i "<module>"
   ```

2. **构建测试目标**

   ```bash
   # CMake 项目
   cmake --build build --target <module>_test

   # 或构建全部测试
   cmake --build build --target all_tests
   ```

3. **运行模块相关测试**

   ```bash
   # Google Test 过滤执行
   ./build/test/<module>_test
   # 或
   ./build/unit_tests --gtest_filter="*<Module>*"

   # CTest 过滤执行
   ctest -R "<module>" -V

   # Bazel 项目
   bazel test //<path>:<module>_test
   ```

4. **分析测试输出**

   - 记录测试通过/失败数量
   - 关注失败测试揭示的预期行为
   - 检查测试日志中的关键信息
   - 注意执行时间是否符合预期

5. **验证关键假设**
   - 对静态分析中标注「待确认」的点逐一验证
   - 若测试结果与分析不符，修正模块报告

**产出**：

- 在模块报告「验证状态」中记录：
  - 验证等级：L2
  - 验证方式：运行测试
  - 测试命令：`<实际执行的命令>`
  - 测试结果：`X/Y 通过` 或 `全部通过`
  - 验证发现：
    - 确认：<静态分析正确的点>
    - 修正：<需要修正的理解>
    - 新发现：<测试揭示的额外信息>

---

## L3: 探索性测试验证

**触发条件**：

- 模块复杂度为「极高」，或
- 复杂度「高」但现有测试覆盖不足（测试数量 < 5 或关键功能无测试）

**目的**：对缺乏测试覆盖的复杂模块，通过编写简单测试验证关键假设

**适用场景**：

- 静态分析无法确认的关键行为
- 涉及并发、状态机、外部依赖的复杂逻辑
- 文档/注释与代码可能不一致的情况

**步骤**：

1. **识别待验证假设**

   - 从静态分析中提取 3–5 个关键假设
   - 优先选择：
     - 模块的核心功能
     - 边界条件处理
     - 错误处理逻辑
     - 并发/线程安全性

2. **编写最小化测试**

   ```cpp
   // 探索性测试示例（Google Test）
   #include <gtest/gtest.h>
   #include "<module>.h"

   // 验证假设 1: 初始化后状态正确
   TEST(ModuleExploreTest, InitializationState) {
       Module m;
       m.init();
       EXPECT_EQ(m.state(), Module::INITIALIZED);
   }

   // 验证假设 2: 错误输入的处理
   TEST(ModuleExploreTest, InvalidInputHandling) {
       Module m;
       auto result = m.process(nullptr);
       EXPECT_EQ(result.error_code, ERR_INVALID_INPUT);
   }
   ```

3. **执行探索性测试**

   ```bash
   # 编译并运行
   g++ -std=c++17 -I<include_path> explore_test.cpp -lgtest -lgtest_main -o explore_test
   ./explore_test
   ```

4. **根据结果修正理解**

   - 测试通过 → 假设确认
   - 测试失败 → 分析原因，修正模块报告
   - 编译错误 → 检查 API 理解是否正确

5. **决定测试代码去留**
   - 若测试有价值，可建议保留并提交
   - 若仅用于验证理解，可在分析完成后删除
   - 在模块报告中记录测试代码位置（若保留）

**产出**：

- 在模块报告「验证状态」中记录：
  - 验证等级：L3
  - 验证方式：探索性测试
  - 验证的假设列表
  - 每个假设的验证结果（确认/修正）
  - 探索性测试代码位置（若保留）

---

## 验证等级选择流程

```
开始
  │
  ▼
复杂度 = 低？ ──是──▶ L0（无需验证）
  │
  否
  │
  ▼
复杂度 = 中？ ──是──▶ 有测试？ ──是──▶ L1（阅读测试）
  │                      │
  否                     否
  │                      │
  ▼                      ▼
复杂度 = 高？ ──是──▶ 有足够测试？ ──是──▶ L2（运行测试）
  │                      │
  否                     否
  │                      │
  ▼                      ▼
复杂度 = 极高 ────────────────────────▶ L3（探索性测试）
```

---

## 在模块报告中的填写

在 [模块报告](1-code-cognition/templates/module-report.md) 的「验证状态」章节中：

- **复杂度「低」**：可省略「验证状态」章节，或写「L0 - 静态分析」
- **复杂度「中」及以上**：必须填写验证等级、方式、结果、发现

---

**下一步**：返回调用此文档的 [Skill 02](1-code-cognition/skills/skill-02-modules.md) 或 [Phase 02](1-code-cognition/phases/02-modules.md)，继续执行模块验证。
