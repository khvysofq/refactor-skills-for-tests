# 测试分层定义

> **阅读时机**：选择测试策略时。

---

## 三层测试体系

### L1: 纯单元测试

**特征**：
- 无 I/O（文件/网络/数据库）
- 无后台线程
- 无 sleep/延时
- 所有依赖可替换（mock/fake/stub）

| 属性 | 值 |
|------|-----|
| 执行速度 | 毫秒级 |
| 隔离性 | 完全隔离 |
| 确定性 | 100% 确定 |

**适用场景**：
- 纯计算逻辑
- 数据结构操作
- 算法实现
- 解析/序列化逻辑
- 状态机转换

**示例**：

```cpp
// L1 测试示例
TEST(Calculator, AddTwoNumbers) {
    Calculator calc;
    EXPECT_EQ(calc.add(2, 3), 5);
}
```

### L2: 组件/契约测试

**特征**：
- 依赖使用 fake/embedded/loopback 替代
- 可能有受控的 I/O（内存文件系统、loopback 网络）
- 测试组件边界契约

| 属性 | 值 |
|------|-----|
| 执行速度 | 秒级 |
| 隔离性 | 组件级隔离 |
| 确定性 | 高确定性（需控制外部依赖） |

**适用场景**：
- 模块集成点
- 接口契约验证
- 协议解析
- 状态管理组件

**依赖替换策略**：

| 真实依赖 | L2 替代方案 |
|----------|-------------|
| 文件系统 | 内存文件系统 / 临时目录 |
| 网络 | Loopback / Mock Server |
| 数据库 | SQLite in-memory / Embedded DB |
| 时间 | 注入 Clock 接口 |
| 随机数 | 注入 RNG 接口 |

### L3: 系统回归测试

**特征**：
- 端到端验证
- 使用真实或准真实依赖
- 少量关键路径覆盖

| 属性 | 值 |
|------|-----|
| 执行速度 | 分钟级 |
| 隔离性 | 最小隔离 |
| 确定性 | 需要环境控制 |

**适用场景**：
- 关键业务流程
- 集成点验证
- 部署验证
- 性能基准

---

## 选择决策规则

按以下顺序判断，选择第一个匹配的测试层级：

| 步骤 | 问题 | 否 | 是 |
|------|------|-----|-----|
| Q1 | 被测代码是否有外部依赖？ | 选择 **L1** | 继续 Q2 |
| Q2 | 依赖是否已有抽象层？ | 继续 Q4 | 继续 Q3 |
| Q3 | 替换依赖后测试是否有意义？ | 选择 **L2**（需要真实交互） | 选择 **L1**（使用 mock/fake） |
| Q4 | 能否引入 seam？ | 选择 **L3**（最后手段） | 先执行 Skill 07 引入 seam，再选择 L1/L2 |

**决策总结**：
- 无外部依赖 → L1
- 有依赖且已有抽象层，mock 有意义 → L1
- 有依赖且已有抽象层，需真实交互 → L2
- 有依赖无抽象层，可引入 seam → Skill 07 后选择 L1/L2
- 有依赖无抽象层，无法引入 seam → L3

---

## 分层策略建议

### 理想比例（测试金字塔）

| 测试层级 | 比例 | 覆盖范围 |
|----------|------|----------|
| L1 单元测试 | ~70% | 核心逻辑（金字塔底部，数量最多） |
| L2 组件测试 | ~20% | 组件边界（金字塔中部） |
| L3 系统测试 | ~10% | 少量关键路径（金字塔顶部，数量最少） |

**原则**：L1 数量最多、执行最快；L3 数量最少、覆盖关键路径。

### 每模块最小要求

| 模块类型 | L1 | L2 | L3 |
|----------|----|----|----| 
| 核心算法 | ✓ 必须 | 可选 | 不需要 |
| 数据处理 | ✓ 必须 | ✓ 推荐 | 可选 |
| I/O 封装 | 可选 | ✓ 必须 | 可选 |
| 集成层 | 不需要 | ✓ 必须 | ✓ 推荐 |
| 入口/main | 不需要 | 可选 | ✓ 必须 |

---

## 覆盖率指导

### L1 覆盖率目标

| 指标 | 基础 | 推荐 | 严格 |
|------|------|------|------|
| 行覆盖率 | 60% | 80% | 90% |
| 分支覆盖率 | 50% | 70% | 85% |
| 函数覆盖率 | 80% | 90% | 95% |

### 不追求覆盖率的场景

- 错误处理的极端路径
- 平台特定的条件编译分支
- 已废弃但未删除的代码
- 纯防御性代码

---

**下一步**：返回调用此文档的阶段/Skill 继续执行
